local zoneFirstRoom = {
aardington="aardington-0",
abend="abend-0",
academy="academy-0",
adaldar="adaldar-0",
afterglow="afterglow-0",
agroth="agroth-0",
ahner="ahner-0",
alagh="alagh-0",
alehouse="alehouse-0",
amazon="amazon-0",
amazonclan="amazonclan-0",
amusement="amusement-0",
andarin="andarin-0",
annwn="annwn-0",
anthrox="anthrox-26",
arboretum="arboretum-0",
arena="arena-8",
arisian="arisian-0",
ascent="ascent-0",
asherodan="asherodan-0",
astral="astral-1",
atlantis="atlantis-10",
autumn="autumn-0",
avian="avian-42",
aylor="aylor-0",
baal="baal-0",
badtrip="badtrip-0",
bard="bard-1",
bazaar="bazaar-1",
beer="beer-0",
believer="believer-0",
birthday="birthday-0",
blackclaw="blackclaw-9",
blackrose="blackrose-0",
bliss="bliss-0",
bonds="bonds-0",
bootcamp="bootcamp-0",
cabal="cabal-0",
caldera="caldera-0",
callhero="callhero-0",
camps="camps-0",
canyon="canyon-0",
caravan="caravan-1",
cards="cards-0",
carnivale="carnivale-0",
cataclysm="cataclysm-0",
cathedral="cathedral-0",
cats="cats-0",
chakra="chakra-207",
challenge="challenge-0",
chantry="chantry-0",
chaos="chaos-2",
chasm="chasm-67",
chessboard="chessboard-63",
childsplay="childsplay-0",
cineko="cineko-0",
citadel="citadel-0",
conflict="conflict-0",
coral="coral-0",
cougarian="cougarian-0",
cove="cove-0",
cradle="cradle-50",
crimson="crimson-0",
crusaders="crusaders-0",
crynn="crynn-0",
damned="damned-0",
daoine="daoine-0",
darklight="darklight-15",
darkside="darkside-0",
ddoom="ddoom-0",
deadlights="deadlights-0",
deathtrap="deathtrap-0",
deneria="deneria-0",
desert="desert-0",
desolation="desolation-0",
dhalgora="dhalgora-79",
diatz="diatz-0",
diner="diner-98",
doh="doh-0",
dominion="dominion-2",
dortmund="dortmund-0",
drageran="drageran-7",
dragon="dragon-5",
dread="dread-0",
druid="druid-30",
dsr="dsr-0",
dundoom="dundoom-0",
dunes="dunes-0",
dungeon="dungeon-183",
dunoir="dunoir-0",
duskvalley="duskvalley-0",
dynasty="dynasty-0",
earthlords="earthlords-0",
earthplane="earthplane-0",
elemental="elemental-0",
emerald="emerald-0",
empire="empire-0",
empyrean="empyrean-107",
entropy="entropy-0",
fantasy="fantasy-0",
farm="farm-0",
fayke="fayke-0",
fens="fens-0",
fields="fields-0",
firebird="firebird-1",
firenation="firenation-0",
fireswamp="fireswamp-0",
fortress="fortress-0",
fortune="fortune-0",
fractal="fractal-0",
fractured="fractured-0",
ft1="ft1-0",
ftii="ftii-0",
gaardian="gaardian-1",
gallows="gallows-0",
gathering="gathering-0",
gauntlet="gauntlet-0",
gelidus="gelidus-0",
geniewish="geniewish-1",
gilda="gilda-0",
glamdursil="glamdursil-0",
glimmerdim="glimmerdim-0",
gnomalin="gnomalin-95",
goldrush="goldrush-0",
graveyard="graveyard-0",
greece="greece-103",
gwillim="gwillim-0",
hades="hades-0",
hatchling="hatchling-9",
hawklord="hawklord-0",
hedge="hedge-0",
helegear="helegear-0",
hell="hell-1",
hoard="hoard-3",
hodgepodge="hodgepodge-0",
hook="hook-0",
horath="horath-0",
horizon="horizon-75",
icefall="icefall-1",
illoria="illoria-0",
imagi="imagi-0",
immhomes="immhomes-0",
imperial="imperial-11",
imperium="imperium-0",
infamy="infamy-0",
inferno="inferno-118",
infest="infest-0",
insan="insan-0",
jenny="jenny-2",
jotun="jotun-1",
kearvek="kearvek-0",
kerofk="kerofk-146",
ketu="ketu-17",
kingsholm="kingsholm-1",
knossos="knossos-0",
kobaloi="kobaloi-0",
kultiras="kultiras-0",
lab="lab-0",
labyrinth="labyrinth-0",
lagoon="lagoon-0",
landofoz="landofoz-6",
lasertwo="lasertwo-0",
laym="laym-2",
legend="legend-34",
lemdagor="lemdagor-0",
lidnesh="lidnesh-0",
light="light-1",
limbo="limbo-0",
livingmine="livingmine-0",
logging="logging-0",
longnight="longnight-0",
loqui="loqui-0",
losttime="losttime-0",
lowlands="lowlands-0",
lplanes="lplanes-0",
lualand="lualand-0",
maelstrom="maelstrom-0",
masaki="masaki-0",
masq="masq-7",
mayhem="mayhem-0",
melody="melody-0",
mesolar="mesolar-0",
midgaard="midgaard-0",
minos="minos-0",
mistridge="mistridge-81",
monastery="monastery-0",
mudwog="mudwog-3",
nanjiki="nanjiki-0",
necro="necro-0",
nenukon="nenukon-0",
newthalos="newthalos-283",
ninehells="ninehells-0",
northstar="northstar-0",
nottingham="nottingham-0",
nulan="nulan-0",
nursing="nursing-1",
nynewoods="nynewoods-2",
oceanpark="oceanpark-0",
oldclanfou="oldclanfou-0",
oldclanone="oldclanone-0",
oldclanthr="oldclanthr-0",
oldclantwo="oldclantwo-0",
oldvanir="oldvanir-0",
omentor="omentor-1",
ooku="ooku-0",
oradrin="oradrin-0",
origins="origins-0",
orlando="orlando-0",
paradise="paradise-0",
partroxis="partroxis-98",
peninsula="peninsula-0",
perdition="perdition-0",
petstore="petstore-12",
pompeii="pompeii-2",
promises="promises-0",
prosper="prosper-0",
pyre="pyre-5",
qong="qong-50",
quarry="quarry-0",
radiance="radiance-0",
raga="raga-0",
raukora="raukora-0",
rebellion="rebellion-0",
remcon="remcon-0",
reme="reme-0",
retri="retri-0",
rhabdo="rhabdo-0",
rogues="rogues-0",
romani="romani-2",
rosewood="rosewood-0",
ruins="ruins-0",
sagewood="sagewood-0",
sahuagin="sahuagin-0",
salt="salt-0",
sanctity="sanctity-0",
sanctum="sanctum-0",
sandcastle="sandcastle-0",
sanguine="sanguine-0",
scarred="scarred-0",
seaking="seaking-0",
seekers="seekers-0",
sendhian="sendhian-0",
sennarre="sennarre-0",
shadokil="shadokil-54",
shadowsend="shadowsend-0",
shouggoth="shouggoth-1",
siege="siege-0",
sirens="sirens-26",
slaughter="slaughter-1",
snuckles="snuckles-0",
soh="soh-0",
sohtwo="sohtwo-0",
solan="solan-1",
songpalace="songpalace-0",
southern="southern-29",
spyreknow="spyreknow-0",
stone="stone-0",
storm="storm-0",
stormhaven="stormhaven-0",
stronghold="stronghold-0",
stuff="stuff-0",
takeda="takeda-23",
talsa="talsa-0",
tanelorn="tanelorn-6",
tanra="tanra-0",
tao="tao-0",
temple="temple-0",
terra="terra-0",
terramire="terramire-0",
thieves="thieves-0",
tilule="tilule-0",
times="times-0",
tirna="tirna-0",
titan="titan-0",
tol="tol-0",
tombs="tombs-0",
touchstone="touchstone-0",
transcend="transcend-0",
twinlobe="twinlobe-0",
umari="umari-45",
uncharted="uncharted-0",
underdark="underdark-227",
uplanes="uplanes-0",
uprising="uprising-0",
vale="vale-0",
vanir="vanir-0",
vault="vault-0",
verdure="verdure-0",
verume="verume-0",
vidblain="vidblain-0",
village="village-0",
vlad="vlad-0",
volcano="volcano-0",
warzone="warzone-0",
watchmen="watchmen-8",
weather="weather-0",
werewood="werewood-0",
whiteclaw="whiteclaw-0",
wildwood="wildwood-0",
winds="winds-0",
winter="winter-1",
wizards="wizards-0",
wolfmaze="wolfmaze-0",
wonders="wonders-0",
wooble="wooble-0",
woodelves="woodelves-0",
wtc="wtc-0",
wyrm="wyrm-43",
xmas="xmas-0",
xunti="xunti-0",
xylmos="xylmos-99",
yarr="yarr-0",
ygg="ygg-0",
yurgach="yurgach-94",
zangar="zangar-0",
zenith="zenith-0",
zodiac="zodiac-0",
zoo="zoo-22",
zyian="zyian-0"}

local long = nil
local short = nil
local dest = nil
local owner = nil
local id = nil
local zone = nil

function firstToUpper(str)
    return (str:gsub("^%l", string.upper))
end

function split (inputstr, sep)
   if sep == nil then
      sep = "%s"
   end
   local t={}
   for str in string.gmatch(inputstr, "([^"..sep.."]+)") do
      table.insert(t, str)
   end
   return t
end

function captureKeywords(name,line,wildcards)
   local s = wildcards[1]
   SetVariable("restring_Keywords",s)
   EnableTrigger("trg_restringKeywords",false)
end

function capture_restringID(name,line,wildcards)
   local id = wildcards[1]
   SetVariable("restring_ID",id)
   EnableTrigger("trg_restringID",false)
   DoAfterSpecial(.5,'restringHelp()',sendto.script)
end

function capture_firstroom(name,line,wildcards)
   local rid = wildcards[1]
   EnableTrigger("trg_FirstRoom",false)
   SetVariable("tportal_Dest",rid)
   DoAfterSpecial(.5,'tportalHelp()',sendto.script)
end

function pluginHelp()
   Note("----------------------------------------------------------------------------")
   Note(" To start a new restring, type 'restring <keyword>' for item in your")
   Note(" inventory.")
   Note("")
   Note(" To start a new trivia portal, type 'tportal <zone>'.")
   Note("")
   Note(" Additional help will be displayed once you type these commands.")
   Note("----------------------------------------------------------------------------")
end


function restringHelp(name,line,wildcards)
   Note("To perform restring, use:")
   Note("   keywords <all keywords here>  This will be appended to current keywords: '"..GetVariable("restring_Keywords").."'") 
   Note("   short <shortdesc here>")
   Note("   long <roomdesc here>")
   Note("You can use 'restring check' followed by 'restring set' once you're done. You must check before you set.")
   Note("Once the item restring has been completed, use 'restring charge <playername>' to pcharge the player.")
   Note("You can use 'restring balance <playername>' to check their TP balance before you start.")
   Note("")
   Execute("restring check")
end

function tportalHelp(name,line,wildcards)
   Note("To perform restring, use:")
   Note("   keywords <all keywords here> (first two keywords will automatically be 'trivia portal', you do not need these.)") 
   Note("   short <shortdesc here>")
   Note("   long <roomdesc here>")
   Note("   owner <playername>")
   Note("You can use 'tportal check' followed by 'tportal create' once you're done. You must check before you create.")
   Note("Once the portal has been completed, use 'tportal charge' to pcharge the owner.")
   Note("You can use 'tportal balance' to check their TP balance before you create the portal.")
   Note("")
   Execute("tportal check")
end

function checkShort(name,line,wildcards)
   local s = wildcards[1]
   if string.len(s) > 40 then
      Note("Error: Length is over 40 characters ("..string.len(s)..")")
   end
   EnableTrigger("trg_checkShort",false)
end

function checkLong(name,line,wildcards)
   local s = wildcards[1]
   if string.len(s) > 80 then   
      Note("Warning: Length is over 80 characters")
   end                                        
   EnableTrigger("trg_checkLong",false)
end

function setShort(name,line,wildcards)
   local s = wildcards[1]
   -- Ensure we're not editing or writing notes.
   local state
   res, state = CallPlugin("3e7dedbe37e44942dd46d264","gmcpval","char.status.state")
   if state == "5" or state == "6" then Send(line) return end

   if s == "clear" then
      SetVariable("restring_Short","")
      Note("Short description cleared.")
      return
   end
   if string.len(s) > 100 then Note("Error: String with color codes must be 100 characters or less.") return end
   
   local last = ''
      for m in string.gmatch(s,'@%g') do
      last = m
   end
   if last ~= '' and last ~= '@w' then Note("Error: String contains color codes, but does not end with @w.") return end
   short = s
   Note("Short description for restring set to: "..s)
   EnableTrigger("trg_checkShort",true)
   Send("echo self Short: "..s)
end

function setLong(name,line,wildcards)
   local s = wildcards[1]
   -- Ensure we're not editing or writing notes.
   local state
   res, state = CallPlugin("3e7dedbe37e44942dd46d264","gmcpval","char.status.state")
   if state == "5" or state == "6" then Send(line) return end
   if s == "clear" then
      SetVariable("restring_Long","")
      Note("Long description cleared.")
      return
   end
   local last = ''
      for m in string.gmatch(s,'@%g') do
      last = m
   end
   if last ~= '' and last ~= '@w' then Note("Error: String contains color codes, but does not end with @w.") return end
   if string.len(s) > 80 then Note("Error: Room/Long description can only be 80 chars, including color codes.") return end
   long = s
   Note("Long description for restring set to: "..s)
   EnableTrigger("trg_checkLong",true)
   Send("echo self Long: "..s)
end

function setKeywords(name,line,wildcards)
   -- To Do: add check that there are not more than 3 added keywords.
   local s = wildcards[1]
   local res
   -- Ensure we're not editing or writing notes.
   local state
   res, state = CallPlugin("3e7dedbe37e44942dd46d264","gmcpval","char.status.state")
   if state == "5" or state == "6" then Send(line) return end
   if s == "clear" then
      SetVariable("restring_AddKeywords","")
      Note("Extra keywords cleared.")
      return
   end
   if select(2,s:gsub("%S+","")) > 3 then Note("Error: You cannot have more than 3 additional keywords") return end
   if string.find(s,"'") then Note("Error: keywords cannot contain quotes.") return end
   if string.find(s,'"') then Note("Error: keywords cannot contain quotes.") return end
   if string.find(s,'@') then Note("Error: keywords cannot contain color codes.") return end
   keywords = s
   Note("Additional Keywords for object will be: "..s)
   Note("Full keywords will be: "..GetVariable("restring_Keywords").." "..s)
end

function setOwner(name,line,wildcards)
   local s = firstToUpper(wildcards[1])
   -- Ensure we're not editing or writing notes.
   local state
   res, state = CallPlugin("3e7dedbe37e44942dd46d264","gmcpval","char.status.state")
   if state == "5" or state == "6" then Send(line) return end
   owner = s
   Note("Owner for the trivia portal will be: "..s)
end

function restringCommand(name,line,wildcards)
   local s = wildcards[1]
   if s == "help" then pluginHelp() return end
   if s == "check" then
      local addkw = GetVariable("restring_AddKeywords")
      local short = GetVariable("restring_Short")
      local long = GetVariable("restring_Long")
      if addkw == '' then addkw = '(unchanged)' end
      if short == '' then short = '(unchanged)' end
      if long == '' then long = '(unchanged)' end
      Note("Restring check for item "..GetVariable("restring_ID"))
      Note("Keywords: "..GetVariable("restring_Keywords").." "..addkw)
      Note("Short   : "..short)
      Note("Long    : "..long)
      SetVariable("restring_Checked","yes")
   elseif s == "set" then
      if GetVariable("restring_Checked") == "yes" then
         local id = GetVariable("restring_ID")
         local short = GetVariable("restring_Short")
         local long = GetVariable("restring_Long")
         local kw = GetVariable("restring_Keywords").." "..GetVariable("restring_AddKeywords")
         if kw ~= '' then Send("ostring "..id.." keywords "..'"'..kw..'"') else Note("Warning: keywords are unchanged, not attempting change keywords.") end
         if short ~= '' then Send("ostring "..id.." short "..'"'..short..'"') else Note("Warning: Short desc is unchanged, not attempting to change short desc.") end
         if long ~= '' then Send("ostring "..id.." long "..'"'..long..'"') else Note("Warning: long desc is unchanged, not attempting to change long desc.") end
         SetVariable("restring_Set","yes")
      else
         Note("You should run 'restring check' first!")
      end
   elseif string.sub(s,1,6) == "charge" then
      if GetVariable("restring_Set") == "yes" then
         local player = string.sub(s,8)
         local id = GetVariable("restring_ID")
         if string.len(player) < 2 then
            Note("You must specify a player name!")
         else
            Send("pcharge "..player.." 0 2 0 Restring of item "..id)
         end
      else
         Note("You should probably run 'restring set' first!")
      end
   elseif string.sub(s,1,7) == "balance" then
      local player = string.sub(s,9)
      if string.len(player) < 2 then
         Note("You must specify a player name!")
      else
         Send("pcharge "..player.." 0 0 0 Checking balance before restring")
      end
   else
      EnableTrigger("trg_restringID",true)
      EnableTrigger("trg_restringKeywords",true)
      SetVariable("restring_AddKeywords","")
      SetVariable("restring_Short","")
      SetVariable("restring_Long","")
      Send("ostat '"..s.."' here")
      SetVariable("restring_Checked","no")
      SetVariable("restring_Set","no")
   end
end

function tportalCommand(name,line,wildcards)
   local s = wildcards[1]
   local arguments = split(s," ")
   if #arguments > 1 then Note("Error: tportal only expects 1 argument. Type 'tportal help' for help.") return end
   if s == "owner" then Note("Error: tportal owner isn't a valid command.") return end
   if s == "keywords" then Note("Error: tportal keywords isn't a valid command.") return end
   if s == "short" then Note("Error: tportal short isn't a valid command.") return end
   if s == "long" then Note("Error: tportal long isn't a valid command.") return end
   if s == "help" then pluginHelp() return end
   if s == "check" then
      local kw
      if keywords == nil then kw = '<none additional set>' else kw = "trivia portal "..keywords end
      if short == nil then short = 'Needs to be set!' end
      if long == '' then long = 'Needs to be set!' end
      if owner == '' then owner = 'Needs to be set!' end
      if dest == '' then dest = 'Needs to be set!' end
      Note("String check for new trivia portal:")
      Note("Keywords: "..kw)
      Note("Short   : "..short)
      Note("Long    : "..long)
      Note("Owner   : "..owner)
      Note("Dest    : "..dest)
   elseif s == "create" then
      local kw = "trivia portal "..keywords
      if keywords == nil or short == nil or long == nil or owner == nil or dest == nil or zone == nil then Note("You must set all the required fields. Use 'tportal check' to verify your work!") return end
      Send("oload badtrip-9")
      Send("ostring 'trivia portal' short "..'"'..short..'"')
      Send("ostring 'trivia portal' long "..'"'..long..'"')
      Send("ostring 'trivia portal' keywords "..'"'..kw..'"')
      Send("ostring 'trivia portal' owner "..owner)
      Send("oset 'trivia portal' destination "..dest)
      Send("keep 'trivia portal'")
      Send("pcharge "..owner.." 0 15 0 New Trivia Portal to area "..zone)
   elseif s == "charge" then
      if GetVariable("restring_Set") == "yes" then
         if owner == '' then
            Note("You must define an owner for the trivia portal first! (owner <playername>)")
         else
            Send("pcharge "..owner.." 0 15 0 New Trivia Portal to area "..zone)
         end
      else
         Note("You should probably run 'tportal create' first!")
      end
   elseif s == "balance" then
      if owner == '' then
         Note("You must define an owner for the trivia portal first! (owner <playername>)")
      else
         Send("pcharge "..owner.." 0 0 0 Checking balance before restring")
      end
   else
      local badzones = {"limbo","mesolar","alagh","abend","gelidus","vidblain","uncharted","southern","uplanes","ninehells","lplanes","immhomes","warzone","lasertwo","oradrin","inferno","terra","icefall","titan","winds","genie","transcend","whiteclaw","blackclaw","seaking","prosper","darkside","soh2"}
      for i,v in ipairs(badzones) do
         if s == v then Note("That is an illegal zone for a trivia portal. Check helpfiles for more information!") return end
      end
      if zoneFirstRoom[s] ~= nil then
         dest = zoneFirstRoom[s]
         Note("Portal destination will be: "..dest)
         owner = nil
         short = nil
         long = nil
         keywords = nil
         zone = s
      else
      	 Note("That zone is unknown. If it exists, ensure it's in the plugin! (restring_scripts.lua)")
      end
   end
end